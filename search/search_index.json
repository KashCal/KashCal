{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"KashCal","text":"<p>Workflow-first calendar app with offline-first architecture and CalDAV sync.</p> <p>KashCal is an Android calendar application designed for users who want full control over their calendar data. It supports CalDAV synchronization with iCloud, Nextcloud, Radicale, Baikal, Stalwart, FastMail, and other CalDAV-compatible servers.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Offline-First: Create and edit events instantly, sync happens in the background</li> <li>CalDAV Sync: Full RFC 4791/5545 compliance for calendar synchronization</li> <li>Multiple Accounts: Connect iCloud, Nextcloud, and self-hosted CalDAV servers</li> <li>Recurring Events: Complete RRULE support with exception handling</li> <li>ICS Subscriptions: Subscribe to public calendars (holidays, sports, etc.)</li> <li>Contact Birthdays: Import birthdays from your contacts</li> <li>Home Screen Widgets: Agenda, week view, and date widgets</li> <li>Reminders: Configurable notifications with snooze support</li> <li>Full-Text Search: Fast FTS4-powered event search</li> <li>Privacy-Focused: No analytics, credentials encrypted with Android Keystore</li> </ul>"},{"location":"#architecture-highlights","title":"Architecture Highlights","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    UI Layer                             \u2502\n\u2502         (Jetpack Compose, Material 3, ViewModels)       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                  Domain Layer                           \u2502\n\u2502    (EventCoordinator, EventReader, OccurrenceGenerator) \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                   Sync Layer                            \u2502\n\u2502  (CalDavSyncWorker, PullStrategy, PushStrategy, Client) \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                   Data Layer                            \u2502\n\u2502      (Room Database, EncryptedSharedPreferences)        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"#quick-start","title":"Quick Start","text":"<ol> <li>Install KashCal from F-Droid or GitHub Releases</li> <li>Open the app - a local calendar is created automatically</li> <li>Add your CalDAV account in Settings</li> <li>Start creating events!</li> </ol>"},{"location":"#supported-caldav-providers","title":"Supported CalDAV Providers","text":"Provider Status Notes iCloud Tested Requires app-specific password Nextcloud Tested Full support Radicale Tested Self-hosted Baikal Tested Self-hosted Stalwart Tested Self-hosted FastMail Tested Full support Any CalDAV Should work RFC 4791 compliant servers"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>Getting Started - Installation and setup</li> <li>Architecture - How KashCal is built</li> <li>CalDAV Sync - Synchronization details</li> <li>Development - Build and contribute</li> </ul>"},{"location":"#license","title":"License","text":"<p>KashCal is open source software. See the LICENSE file for details.</p>"},{"location":"architecture/data-layer/","title":"Data Layer","text":"<p>The data layer provides persistent storage using Room database with encrypted credential storage via Android Keystore.</p>"},{"location":"architecture/data-layer/#database-schema","title":"Database Schema","text":"<p>KashCal uses Room with 9 entities across 12 migrations (current version: 12).</p>"},{"location":"architecture/data-layer/#entity-relationship-diagram","title":"Entity Relationship Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     1:N     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     1:N     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Account   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502  Calendar   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6\u2502    Event    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                   \u2502                          \u2502\n                                   \u2502 1:N                      \u2502 1:N\n                                   \u25bc                          \u25bc\n                            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                            \u2502IcsSubscript.\u2502            \u2502 Occurrence  \u2502\n                            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                              \u2502\n                                                              \u2502 link\n                                                              \u25bc\n                                                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                                       \u2502 Scheduled   \u2502\n                                                       \u2502  Reminder   \u2502\n                                                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/data-layer/#core-entities","title":"Core Entities","text":""},{"location":"architecture/data-layer/#event-73-columns","title":"Event (73 columns)","text":"<p>The primary entity storing calendar events with full RFC 5545 support.</p> Section Fields Identity <code>id</code>, <code>uid</code>, <code>importId</code>, <code>calendarId</code> Content <code>title</code>, <code>location</code>, <code>description</code>, <code>startTs</code>, <code>endTs</code>, <code>timezone</code>, <code>isAllDay</code> Recurrence <code>rrule</code>, <code>rdate</code>, <code>exdate</code>, <code>duration</code> Exception <code>originalEventId</code>, <code>originalInstanceTime</code>, <code>originalSyncId</code> Reminders <code>reminders</code> (JSON), <code>alarmCount</code>, <code>rawIcal</code> RFC 5545/7986 <code>priority</code>, <code>geoLat</code>, <code>geoLon</code>, <code>color</code>, <code>url</code>, <code>categories</code> Sync <code>caldavUrl</code>, <code>etag</code>, <code>sequence</code>, <code>syncStatus</code> Timestamps <code>dtstamp</code>, <code>localModifiedAt</code>, <code>serverModifiedAt</code> <p>Key indices:</p> <ul> <li><code>(calendar_id, uid, original_instance_time)</code> - Exception lookup</li> <li><code>(original_event_id, original_instance_time)</code> - Unique exception</li> <li><code>caldav_url</code> - Server URL lookup</li> <li><code>import_id</code> - ICS import deduplication</li> </ul>"},{"location":"architecture/data-layer/#occurrence","title":"Occurrence","text":"<p>Materialized RRULE expansions for O(1) range queries.</p> <pre><code>@Entity(\n    indices = [\n        Index(\"event_id\"),\n        Index(\"calendar_id\"),\n        Index(\"start_day\", \"end_day\"),\n        Index(value = [\"event_id\", \"start_ts\"], unique = true)\n    ]\n)\ndata class Occurrence(\n    val eventId: Long,           // Master event\n    val calendarId: Long,        // Denormalized for performance\n    val startTs: Long,\n    val endTs: Long,\n    val startDay: Int,           // YYYYMMDD format\n    val endDay: Int,\n    val isCancelled: Boolean,    // EXDATE flag\n    val exceptionEventId: Long?  // Links to exception event (Model B)\n)\n</code></pre> <p>Why materialized?</p> <ul> <li>Calendar views need O(1) range queries</li> <li>RRULE expansion on-the-fly is O(n) per event</li> <li>FTS search needs indexed occurrence times</li> </ul>"},{"location":"architecture/data-layer/#pendingoperation","title":"PendingOperation","text":"<p>Offline-first sync queue with retry logic.</p> <pre><code>data class PendingOperation(\n    val eventId: Long,\n    val operation: String,       // CREATE, UPDATE, DELETE, MOVE\n    val status: String,          // PENDING, IN_PROGRESS, FAILED\n    val retryCount: Int,\n    val maxRetries: Int = 10,    // ~13.5h total backoff\n    val nextRetryAt: Long?,\n    val targetUrl: String?,      // Captured at queue time (critical!)\n    val targetCalendarId: Long?,\n    val sourceCalendarId: Long?, // For cross-account moves\n    val movePhase: Int = 0,      // 0=DELETE, 1=CREATE\n    val lifetimeResetAt: Long,   // 30-day lifetime\n    val failedAt: Long?          // 24h auto-reset trigger\n)\n</code></pre> <p>Retry lifecycle:</p> <ul> <li>Exponential backoff: 30s \u2192 5h cap (10 retries)</li> <li>Auto-reset after 24h in FAILED state</li> <li>Abandoned after 30 days without user interaction</li> </ul>"},{"location":"architecture/data-layer/#sync-status-flow","title":"Sync Status Flow","text":"<pre><code>New Event (CalDAV) \u2192 PENDING_CREATE \u2192 SYNCED\n                           \u2193\n                    (push fails)\n                           \u2193\n                    retry with backoff\n                           \u2193\n                    SYNCED (success)\n\nExisting Event \u2192 PENDING_UPDATE \u2192 SYNCED\n\nDelete Event \u2192 PENDING_DELETE \u2192 (removed from DB)\n\nLocal Only \u2192 SYNCED (never synced)\n</code></pre>"},{"location":"architecture/data-layer/#credential-storage","title":"Credential Storage","text":"<p>Credentials are encrypted using Android Keystore with AES-256-GCM.</p>"},{"location":"architecture/data-layer/#unifiedcredentialmanager","title":"UnifiedCredentialManager","text":"<pre><code>// Storage format: account_{id}_{field}\n// File: unified_credentials (EncryptedSharedPreferences)\n\ndata class AccountCredentials(\n    val username: String,\n    val password: String,\n    val serverUrl: String,\n    val trustInsecure: Boolean = false,\n    val principalUrl: String? = null,\n    val calendarHomeSet: String? = null\n)\n</code></pre> <p>Security features:</p> <ul> <li>Keys encrypted with AES256-SIV</li> <li>Values encrypted with AES256-GCM</li> <li>Master key stored in Android Keystore</li> <li>Excluded from Android backup (<code>backup_rules.xml</code>)</li> <li>Credentials masked in logs (first 3 chars only)</li> </ul>"},{"location":"architecture/data-layer/#repository-layer","title":"Repository Layer","text":"<p>Repositories provide the single source of truth for Account and Calendar operations.</p>"},{"location":"architecture/data-layer/#accountrepository","title":"AccountRepository","text":"<pre><code>interface AccountRepository {\n    // Reactive queries\n    fun getAllAccountsFlow(): Flow&lt;List&lt;Account&gt;&gt;\n\n    // One-shot queries\n    suspend fun getAccountById(id: Long): Account?\n\n    // Write operations\n    suspend fun createAccount(account: Account): Long\n    suspend fun deleteAccount(accountId: Long)  // Full cleanup\n\n    // Credentials (delegated to CredentialManager)\n    suspend fun saveCredentials(accountId: Long, credentials: AccountCredentials): Boolean\n    suspend fun getCredentials(accountId: Long): AccountCredentials?\n}\n</code></pre> <p>deleteAccount() cleanup order:</p> <ol> <li>Cancel WorkManager sync jobs</li> <li>Cancel reminders (need event IDs before cascade)</li> <li>Delete pending operations</li> <li>Delete credentials</li> <li>Cascade delete via Room FK</li> </ol>"},{"location":"architecture/data-layer/#calendarrepository","title":"CalendarRepository","text":"<pre><code>interface CalendarRepository {\n    fun getVisibleCalendarsFlow(): Flow&lt;List&lt;Calendar&gt;&gt;\n    suspend fun setVisibility(calendarId: Long, visible: Boolean)\n    suspend fun updateSyncToken(calendarId: Long, syncToken: String?, ctag: String?)\n}\n</code></pre>"},{"location":"architecture/data-layer/#daos","title":"DAOs","text":""},{"location":"architecture/data-layer/#key-dao-methods","title":"Key DAO Methods","text":"DAO Method Purpose EventsDao <code>getExceptionByUidAndInstanceTime()</code> RFC 5545 exception lookup EventsDao <code>search()</code> FTS4 full-text search OccurrencesDao <code>linkException()</code> Model B exception linking OccurrencesDao <code>getOccurrencesWithEventsInRange()</code> JOIN for calendar views PendingOperationsDao <code>getReadyOperations()</code> Queue processing PendingOperationsDao <code>autoResetOldFailed()</code> 24h retry reset"},{"location":"architecture/data-layer/#fts4-search","title":"FTS4 Search","text":"<p>KashCal uses FTS4 (not FTS5) for Room integration:</p> <pre><code>@Fts4(contentEntity = Event::class)\n@Entity(tableName = \"events_fts\")\ndata class EventFts(\n    val title: String,\n    val location: String?,\n    val description: String?\n)\n</code></pre> <p>Search query:</p> <pre><code>SELECT events.* FROM events\nJOIN events_fts ON events.id = events_fts.rowid\nWHERE events_fts MATCH :query\nLIMIT 100\n</code></pre>"},{"location":"architecture/data-layer/#migrations","title":"Migrations","text":"Version Change 1\u21922 Add ics_subscriptions table 2\u21923 Add scheduled_reminders table 4\u21925 Add pending_operations.target_url, target_calendar_id 5\u21926 Add pending_operations.move_phase 6\u21927 Add Event.raw_ical, import_id, alarm_count 7\u21928 Add RFC 5545/7986 fields (priority, geo, color, url, categories) 8\u21929 Add composite exception lookup index 9\u219210 Add unique (event_id, start_ts) on occurrences 10\u219211 Add pending_operations.lifetime_reset_at, failed_at 11\u219212 Add pending_operations.sourceCalendarId <p>All migrations are idempotent and check existence before creating.</p>"},{"location":"architecture/domain-layer/","title":"Domain Layer","text":"<p>The domain layer provides business logic through EventCoordinator, EventReader, and related components.</p> <p>See Architecture Overview for the complete layer diagram.</p>"},{"location":"architecture/domain-layer/#eventcoordinator","title":"EventCoordinator","text":"<p>Central orchestrator for all event write operations.</p> <p>Key responsibilities: - Create/update/delete events with transaction boundaries - Schedule reminders after modifications - Trigger sync after CalDAV changes - Update widgets after data changes</p>"},{"location":"architecture/domain-layer/#eventreader","title":"EventReader","text":"<p>Read-only queries with Flow support for reactive UI.</p> <p>Key patterns: - Batch loading (3 queries instead of N+1) - Flow with distinctUntilChanged() for deduplication - Uses <code>exceptionEventId ?: eventId</code> for exception events</p>"},{"location":"architecture/domain-layer/#occurrencegenerator","title":"OccurrenceGenerator","text":"<p>RRULE expansion using lib-recur library.</p> <p>Key features: - 2-year default expansion window - On-demand extension for far-future navigation - Exception link preservation during regeneration - UTC timezone for all-day events</p>"},{"location":"architecture/domain-layer/#rrulebuilder","title":"RruleBuilder","text":"<p>Type-safe RRULE construction for UI layer.</p> <p>Never expose lib-recur directly to UI.</p>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>KashCal follows a layered architecture with clear separation of concerns. All data flows through well-defined interfaces, making the codebase testable and maintainable.</p>"},{"location":"architecture/overview/#layer-diagram","title":"Layer Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       UI Layer                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 HomeScreen  \u2502  \u2502 Settings    \u2502  \u2502 EventForm/QuickView \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502         \u2502                \u2502                     \u2502             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502HomeViewModel\u2502  \u2502AccountVM    \u2502  \u2502 Compose Components  \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         \u2502         Domain Layer                \u2502             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502              EventCoordinator (writes)                 \u2502  \u2502\n\u2502  \u2502              EventReader (reads)                       \u2502  \u2502\n\u2502  \u2502              OccurrenceGenerator (RRULE expansion)     \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                      Sync Layer                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 CalDavSyncWorker \u2192 CalDavSyncEngine                   \u2502  \u2502\n\u2502  \u2502     \u251c\u2500\u2500 PushStrategy (local \u2192 server)                 \u2502  \u2502\n\u2502  \u2502     \u251c\u2500\u2500 PullStrategy (server \u2192 local)                 \u2502  \u2502\n\u2502  \u2502     \u2514\u2500\u2500 ConflictResolver (412 handling)               \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                      Data Layer                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 Room Database (9 entities, 12 migrations)             \u2502  \u2502\n\u2502  \u2502 EncryptedSharedPreferences (credentials)              \u2502  \u2502\n\u2502  \u2502 DataStore (preferences)                               \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/overview/#key-principles","title":"Key Principles","text":""},{"location":"architecture/overview/#1-offline-first","title":"1. Offline-First","text":"<p>All user operations complete instantly against the local database. Synchronization happens asynchronously in the background via WorkManager.</p> <pre><code>// User creates event \u2192 instant local write\neventCoordinator.createEvent(event)\n    // 1. Insert into Room DB\n    // 2. Queue PendingOperation\n    // 3. Trigger WorkManager sync\n    // User sees event immediately\n</code></pre>"},{"location":"architecture/overview/#2-single-entry-point-eventcoordinator","title":"2. Single Entry Point (EventCoordinator)","text":"<p>ViewModels never access DAOs directly. All event operations flow through <code>EventCoordinator</code>:</p> <pre><code>// CORRECT\nclass HomeViewModel @Inject constructor(\n    private val coordinator: EventCoordinator,  // Writes\n    private val eventReader: EventReader        // Reads\n)\n\n// WRONG - violates architecture\nclass HomeViewModel @Inject constructor(\n    private val eventsDao: EventsDao  // Never do this\n)\n</code></pre>"},{"location":"architecture/overview/#3-materialized-occurrences","title":"3. Materialized Occurrences","text":"<p>Recurring events are expanded into the <code>occurrences</code> table for O(1) range queries:</p> <pre><code>Event (master data)\n    \u2193 RRULE expansion\nOccurrences table (materialized)\n    \u2193 indexed queries\nCalendar views (instant rendering)\n</code></pre>"},{"location":"architecture/overview/#4-flow-for-reactive-ui","title":"4. Flow for Reactive UI","text":"<p>All read queries return <code>Flow</code> for progressive updates during sync:</p> <pre><code>fun getEventsForDay(dayCode: Int): Flow&lt;List&lt;OccurrenceWithEvent&gt;&gt; =\n    occurrencesDao.getForDayFlow(dayCode)\n        .distinctUntilChanged()\n        .map { occurrences -&gt; loadEventsForOccurrences(occurrences) }\n</code></pre>"},{"location":"architecture/overview/#component-responsibilities","title":"Component Responsibilities","text":"Component Responsibility <code>EventCoordinator</code> Orchestrates all event writes, triggers sync, schedules reminders <code>EventReader</code> Read-only queries with Flow support, batch loading <code>EventWriter</code> Transactional writes with occurrence generation <code>OccurrenceGenerator</code> RRULE expansion using lib-recur <code>CalDavSyncWorker</code> WorkManager entry point for background sync <code>PullStrategy</code> Server \u2192 local sync with etag comparison <code>PushStrategy</code> Local \u2192 server sync with conflict detection <code>AccountRepository</code> Account CRUD with cascade deletion <code>CredentialManager</code> Encrypted credential storage"},{"location":"architecture/overview/#data-flow-examples","title":"Data Flow Examples","text":""},{"location":"architecture/overview/#creating-an-event","title":"Creating an Event","text":"<pre><code>User taps Save\n    \u2193\nHomeViewModel.createEvent()\n    \u2193\nEventCoordinator.createEvent()\n    \u251c\u2500\u2500 EventWriter.createEvent() [transaction]\n    \u2502   \u251c\u2500\u2500 Generate UID\n    \u2502   \u251c\u2500\u2500 Insert into events table\n    \u2502   \u251c\u2500\u2500 Generate occurrences (2-year window)\n    \u2502   \u2514\u2500\u2500 Queue PendingOperation (OPERATION_CREATE)\n    \u251c\u2500\u2500 Schedule reminders\n    \u251c\u2500\u2500 Update widgets\n    \u2514\u2500\u2500 Trigger expedited sync\n    \u2193\nCalDavSyncWorker fires\n    \u2193\nPushStrategy processes queue\n    \u251c\u2500\u2500 Serialize to ICS\n    \u251c\u2500\u2500 PUT to CalDAV server\n    \u2514\u2500\u2500 Mark as SYNCED\n</code></pre>"},{"location":"architecture/overview/#syncing-from-server","title":"Syncing from Server","text":"<pre><code>CalDavSyncWorker.doWork()\n    \u2193\nCalDavSyncEngine.syncCalendar()\n    \u251c\u2500\u2500 PushStrategy (drain pending queue first)\n    \u251c\u2500\u2500 ConflictResolver (handle 412 errors)\n    \u2514\u2500\u2500 PullStrategy\n        \u251c\u2500\u2500 Check ctag (quick change detection)\n        \u251c\u2500\u2500 sync-collection REPORT\n        \u251c\u2500\u2500 calendar-multiget (fetch changed events)\n        \u251c\u2500\u2500 ICalEventMapper (parse iCal \u2192 Event)\n        \u251c\u2500\u2500 linkException() for modified occurrences\n        \u2514\u2500\u2500 Bulk insert/update via Room\n    \u2193\nRoom emits Flow updates\n    \u2193\nUI recomposes with new data\n</code></pre>"},{"location":"architecture/overview/#directory-structure","title":"Directory Structure","text":"<pre><code>app/src/main/kotlin/org/onekash/kashcal/\n\u251c\u2500\u2500 data/\n\u2502   \u251c\u2500\u2500 db/entity/      # Room entities (Event, Calendar, etc.)\n\u2502   \u251c\u2500\u2500 db/dao/         # Data Access Objects\n\u2502   \u251c\u2500\u2500 credential/     # CredentialManager, UnifiedCredentialManager\n\u2502   \u251c\u2500\u2500 repository/     # AccountRepository, CalendarRepository\n\u2502   \u2514\u2500\u2500 preferences/    # KashCalDataStore\n\u251c\u2500\u2500 domain/\n\u2502   \u251c\u2500\u2500 coordinator/    # EventCoordinator\n\u2502   \u251c\u2500\u2500 reader/         # EventReader, SyncLogReader\n\u2502   \u251c\u2500\u2500 writer/         # EventWriter\n\u2502   \u251c\u2500\u2500 generator/      # OccurrenceGenerator\n\u2502   \u251c\u2500\u2500 initializer/    # LocalCalendarInitializer\n\u2502   \u2514\u2500\u2500 rrule/          # RruleBuilder, RruleModels\n\u251c\u2500\u2500 sync/\n\u2502   \u251c\u2500\u2500 worker/         # CalDavSyncWorker\n\u2502   \u251c\u2500\u2500 engine/         # CalDavSyncEngine\n\u2502   \u251c\u2500\u2500 strategy/       # PullStrategy, PushStrategy\n\u2502   \u251c\u2500\u2500 client/         # CalDavClient, OkHttpCalDavClient\n\u2502   \u251c\u2500\u2500 parser/         # ICalEventMapper, IcsPatcher\n\u2502   \u2514\u2500\u2500 provider/       # ICloudQuirks, CalDavCredentialProvider\n\u251c\u2500\u2500 ui/\n\u2502   \u251c\u2500\u2500 viewmodels/     # HomeViewModel, AccountSettingsViewModel\n\u2502   \u251c\u2500\u2500 screens/        # HomeScreen, AccountSettingsScreen\n\u2502   \u251c\u2500\u2500 components/     # EventFormSheet, pickers, etc.\n\u2502   \u2514\u2500\u2500 theme/          # Material 3 theme\n\u251c\u2500\u2500 widget/             # Glance widgets (Agenda, Week, Date)\n\u251c\u2500\u2500 reminder/           # ReminderScheduler, notifications\n\u2514\u2500\u2500 di/                 # Hilt modules\n</code></pre>"},{"location":"architecture/overview/#technology-stack","title":"Technology Stack","text":"Layer Technology UI Jetpack Compose, Material 3 State Management StateFlow, Flow Database Room 2.7 with FTS4 DI Hilt 2.53 Background WorkManager 2.10 Networking OkHttp 4.12 CalDAV icaldav-core 2.8, lib-recur 0.17 Security EncryptedSharedPreferences, Android Keystore Widgets Jetpack Glance 1.1"},{"location":"architecture/sync-layer/","title":"Sync Layer","text":"<p>See How CalDAV Sync Works for detailed sync documentation.</p>"},{"location":"architecture/sync-layer/#components","title":"Components","text":"<ul> <li>CalDavSyncWorker - WorkManager entry point</li> <li>CalDavSyncEngine - Orchestrates push/conflict/pull</li> <li>PushStrategy - Local \u2192 server sync</li> <li>PullStrategy - Server \u2192 local sync</li> <li>ConflictResolver - 412 error handling</li> <li>CalDavClient - HTTP operations</li> </ul>"},{"location":"architecture/sync-layer/#key-files","title":"Key Files","text":"<pre><code>sync/\n\u251c\u2500\u2500 worker/CalDavSyncWorker.kt      # WorkManager job\n\u251c\u2500\u2500 engine/CalDavSyncEngine.kt      # Orchestration\n\u251c\u2500\u2500 strategy/PullStrategy.kt        # ~1,100 lines\n\u251c\u2500\u2500 strategy/PushStrategy.kt        # ~650 lines\n\u251c\u2500\u2500 client/OkHttpCalDavClient.kt    # ~1,300 lines\n\u2514\u2500\u2500 parser/ICalEventMapper.kt       # iCal parsing\n</code></pre>"},{"location":"architecture/ui-layer/","title":"UI Layer","text":"<p>Jetpack Compose with Material 3 design system.</p>"},{"location":"architecture/ui-layer/#viewmodels","title":"ViewModels","text":"<ul> <li>HomeViewModel - Main calendar state (700+ lines of state)</li> <li>AccountSettingsViewModel - Account management</li> </ul>"},{"location":"architecture/ui-layer/#key-patterns","title":"Key Patterns","text":""},{"location":"architecture/ui-layer/#immutable-state","title":"Immutable State","text":"<pre><code>@Immutable\ndata class HomeUiState(\n    val selectedDate: Long,\n    val dayEvents: ImmutableList&lt;OccurrenceWithEvent&gt;,\n    // ...\n)\n</code></pre>"},{"location":"architecture/ui-layer/#flow-observation","title":"Flow Observation","text":"<pre><code>eventReader.getOccurrencesForDay(dayCode)\n    .distinctUntilChanged()\n    .collect { _uiState.update { it.copy(dayEvents = events) } }\n</code></pre>"},{"location":"architecture/ui-layer/#pending-actions","title":"Pending Actions","text":"<pre><code>sealed class PendingAction {\n    data class ShowEventQuickView(val eventId: Long) : PendingAction()\n}\n\n// Consumed via LaunchedEffect\nLaunchedEffect(uiState.pendingAction) {\n    // Handle action then clear\n    viewModel.clearPendingAction()\n}\n</code></pre>"},{"location":"caldav/how-it-works/","title":"How CalDAV Sync Works","text":"<p>KashCal implements full CalDAV synchronization following RFC 4791 (CalDAV) and RFC 5545 (iCalendar).</p>"},{"location":"caldav/how-it-works/#sync-flow","title":"Sync Flow","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    CalDavSyncWorker                          \u2502\n\u2502              (WorkManager background job)                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   CalDavSyncEngine                           \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 PushStrategy\u2502 \u2192 \u2502ConflictRes. \u2502 \u2192 \u2502  PullStrategy   \u2502   \u2502\n\u2502  \u2502 (local\u2192srv) \u2502   \u2502  (412 fix)  \u2502   \u2502   (srv\u2192local)   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Order matters: Push \u2192 Conflict Resolution \u2192 Pull (reduces conflict window)</p>"},{"location":"caldav/how-it-works/#push-strategy","title":"Push Strategy","text":"<p>Local changes are queued in <code>pending_operations</code> and pushed to the server.</p>"},{"location":"caldav/how-it-works/#operation-types","title":"Operation Types","text":"Operation HTTP Method Condition CREATE PUT If-None-Match: * UPDATE PUT If-Match: etag DELETE DELETE If-Match: etag MOVE DELETE + PUT Two-phase operation"},{"location":"caldav/how-it-works/#ics-generation","title":"ICS Generation","text":"<p>Events are serialized to ICS format using <code>IcsPatcher</code>:</p> <pre><code>// For updates: merge changes with original rawIcal\nval ics = IcsPatcher.patch(event, rawIcal)\n\n// For new events: generate fresh ICS\nval ics = IcsPatcher.generateFresh(event)\n\n// Exception events bundled with master\nval ics = IcsPatcher.serializeWithExceptions(master, exceptions)\n</code></pre> <p>Alarm merge strategy:</p> <ul> <li>User's reminder edits update alarm TRIGGER times</li> <li>Original ACTION types preserved (AUDIO, EMAIL, DISPLAY)</li> <li>Properties beyond first 3 alarms preserved via rawIcal</li> </ul>"},{"location":"caldav/how-it-works/#retry-logic","title":"Retry Logic","text":"<pre><code>Retry 1:  30s delay\nRetry 2:  60s delay\nRetry 3:  2m delay\n...\nRetry 10: 5h delay (cap)\n\nAfter 10 retries: FAILED status\nAfter 24h in FAILED: auto-reset to PENDING\nAfter 30 days without user interaction: abandoned\n</code></pre>"},{"location":"caldav/how-it-works/#pull-strategy","title":"Pull Strategy","text":"<p>Server changes are fetched and merged into the local database.</p>"},{"location":"caldav/how-it-works/#change-detection","title":"Change Detection","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           Quick ctag check              \u2502\n\u2502   (single PROPFIND, ~100 bytes)         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n         ctag unchanged? \u2192 Return (no changes)\n                   \u2502\n                   \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502        sync-collection REPORT           \u2502\n\u2502    (incremental since sync-token)       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n         Token expired (403/410)?\n                   \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u25bc                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Etag fallback  \u2502  \u2502   Full sync     \u2502\n\u2502   (~33KB data)  \u2502  \u2502  (~834KB data)  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"caldav/how-it-works/#etag-comparison-bandwidth-optimization","title":"Etag Comparison (Bandwidth Optimization)","text":"<p>When sync-token expires, KashCal fetches only etags instead of full events:</p> <pre><code>// 1. Fetch etags only (~2% of bandwidth)\nval serverEtags = client.fetchEtagsInRange(calendarUrl, startMs, endMs)\n\n// 2. Compare with local\nval changed = serverEtags.filter { localEtags[it.href] != it.etag }\nval newEvents = serverEtags.filter { it.href !in localEtags }\nval deleted = localEtags.keys - serverEtags.map { it.href }\n\n// 3. Fetch only changed events\nval events = client.fetchEventsByHref(calendarUrl, changed + newEvents)\n\n// Saves ~96% bandwidth (33KB vs 834KB for 231 events)\n</code></pre>"},{"location":"caldav/how-it-works/#multiget-fallback","title":"Multiget Fallback","text":"<p>When batch multiget fails, individual fetches are used:</p> <pre><code>Stage 1: Batch multiget (all hrefs at once)\n    \u2193 Failed\nStage 2: Retry after 2000ms delay\n    \u2193 Failed\nStage 3: Individual fetches in batches of 10\n</code></pre>"},{"location":"caldav/how-it-works/#local-first-semantics","title":"Local-First Semantics","text":"<p>Events with pending local changes are NEVER overwritten by server data:</p> <pre><code>// Skip if event has pending changes\nif (pendingOpsDao.hasPendingForEvent(event.id)) {\n    continue  // Don't overwrite local edits\n}\n</code></pre>"},{"location":"caldav/how-it-works/#conflict-resolution","title":"Conflict Resolution","text":"<p>When an event is modified on both client and server (412 Precondition Failed):</p>"},{"location":"caldav/how-it-works/#server-wins-default","title":"Server Wins (Default)","text":"<pre><code>// 1. Fetch server version\nval serverEvent = client.fetchEvent(caldavUrl)\n\n// 2. Parse and validate\nval parsed = ICalEventMapper.map(serverEvent)\n\n// 3. Overwrite local\neventsDao.update(parsed)\n\n// 4. Remove pending operation\npendingOpsDao.delete(operation.id)\n\n// 5. Regenerate occurrences\noccurrenceGenerator.regenerateOccurrences(parsed)\n</code></pre>"},{"location":"caldav/how-it-works/#conflict-abandonment-after-3-cycles","title":"Conflict Abandonment (After 3 Cycles)","text":"<p>If conflict resolution fails repeatedly:</p> <pre><code>if (operation.retryCount &gt;= MAX_CONFLICT_SYNC_CYCLES) {\n    // 1. Reset event to SYNCED (accept server version)\n    eventsDao.updateSyncStatus(eventId, SyncStatus.SYNCED)\n\n    // 2. Clear ctag to force pull\n    calendarsDao.updateCtag(calendarId, null)\n\n    // 3. Delete stuck operation\n    pendingOpsDao.delete(operation.id)\n\n    // 4. Notify user\n    notificationManager.showConflictAbandonedNotification(event)\n}\n</code></pre>"},{"location":"caldav/how-it-works/#exception-events-recurring-event-modifications","title":"Exception Events (Recurring Event Modifications)","text":"<p>When a single occurrence of a recurring event is modified:</p>"},{"location":"caldav/how-it-works/#rfc-5545-requirements","title":"RFC 5545 Requirements","text":"<ul> <li>Exception events share the master's UID</li> <li>Distinguished by RECURRENCE-ID (originalInstanceTime)</li> <li>Bundled with master in single .ics file</li> </ul>"},{"location":"caldav/how-it-works/#model-b-unified","title":"Model B (Unified)","text":"<pre><code>Master Event (id=100, rrule=\"FREQ=WEEKLY\")\n  \u2514\u2500\u2500 Occurrence: eventId=100, startTs=Jan 7 14:00, exceptionEventId=101\n\nException Event (id=101, originalEventId=100)\n  \u2514\u2500\u2500 (no separate occurrence - linked to master's)\n</code></pre> <p>Key pattern:</p> <pre><code>// Load correct event for display\nval eventId = occurrence.exceptionEventId ?: occurrence.eventId\nval event = eventReader.getEventById(eventId)\n</code></pre>"},{"location":"caldav/how-it-works/#provider-quirks","title":"Provider Quirks","text":"<p>Different CalDAV servers have implementation differences handled by <code>CalDavQuirks</code>:</p>"},{"location":"caldav/how-it-works/#icloud-quirks","title":"iCloud Quirks","text":"<ul> <li>Non-prefixed XML namespaces (<code>xmlns=\"DAV:\"</code> vs <code>d:</code>)</li> <li>CDATA-wrapped calendar-data</li> <li>Regional redirect handling (p180-caldav.icloud.com)</li> <li>App-specific password required</li> <li>Skips inbox/outbox/notification/tasks/reminders</li> </ul>"},{"location":"caldav/how-it-works/#detection-logic","title":"Detection Logic","text":"<pre><code>// Check inside &lt;resourcetype&gt; only, not anywhere in response\nprivate fun hasCalendarResourceType(xml: String): Boolean {\n    val resourceTypeRegex = Regex(\n        \"\"\"&lt;(?:d:)?resourcetype[^&gt;]*&gt;(.*?)&lt;/(?:d:)?resourcetype&gt;\"\"\",\n        setOf(RegexOption.DOT_MATCHES_ALL, RegexOption.IGNORE_CASE)\n    )\n    val match = resourceTypeRegex.find(xml) ?: return false\n    val content = match.groupValues[1]\n    return content.contains(\"&lt;calendar\", ignoreCase = true)\n}\n</code></pre>"},{"location":"caldav/how-it-works/#sync-session-tracking","title":"Sync Session Tracking","text":"<p>Each sync operation creates a <code>SyncSession</code> for diagnostics:</p> <pre><code>data class SyncSession(\n    val calendarId: Long,\n    val syncType: SyncType,\n    val trigger: SyncTrigger,\n    val durationMs: Long,\n\n    // Pull statistics\n    val hrefsReported: Int,\n    val eventsFetched: Int,\n    val eventsWritten: Int,\n\n    // Push statistics\n    val eventsPushedCreated: Int,\n    val eventsPushedUpdated: Int,\n    val eventsPushedDeleted: Int,\n\n    // Issues\n    val skippedParseError: Int,\n    val abandonedParseErrors: Int,\n    val fallbackUsed: Boolean\n)\n</code></pre>"},{"location":"caldav/providers/","title":"Supported Providers","text":"Provider Status Notes iCloud Tested Requires app-specific password Nextcloud Tested Full support Radicale Tested Self-hosted, Python Baikal Tested Self-hosted, PHP Stalwart Tested Self-hosted, Rust FastMail Tested Full support Any CalDAV Should work RFC 4791 compliant"},{"location":"caldav/providers/#provider-quirks","title":"Provider Quirks","text":"<p>KashCal handles provider-specific behaviors via <code>CalDavQuirks</code> interface.</p>"},{"location":"caldav/providers/#icloud-quirks","title":"iCloud Quirks","text":"<ul> <li>Non-prefixed XML namespaces</li> <li>CDATA-wrapped calendar-data</li> <li>Regional redirect handling</li> <li>Skips inbox/outbox/tasks collections</li> </ul>"},{"location":"caldav/providers/#standard-caldav","title":"Standard CalDAV","text":"<p>Most servers work with default settings. Toggle \"Trust Self-Signed Certificates\" for self-signed SSL.</p>"},{"location":"caldav/troubleshooting/","title":"Troubleshooting","text":""},{"location":"caldav/troubleshooting/#common-issues","title":"Common Issues","text":""},{"location":"caldav/troubleshooting/#sync-not-working","title":"Sync Not Working","text":"<ol> <li>Check internet connection</li> <li>Verify account credentials</li> <li>Settings \u2192 Sync History for error details</li> <li>Try \"Force Full Sync\" in Settings</li> </ol>"},{"location":"caldav/troubleshooting/#authentication-errors","title":"Authentication Errors","text":"<p>iCloud: - Ensure using app-specific password - Generate new password at appleid.apple.com</p> <p>CalDAV: - Some servers require email as username - Check server logs</p>"},{"location":"caldav/troubleshooting/#events-not-appearing","title":"Events Not Appearing","text":"<ol> <li>Check calendar visibility (Settings \u2192 Calendars)</li> <li>Ensure calendar is synced (pull to refresh)</li> <li>Check date range (far future may need expansion)</li> </ol>"},{"location":"caldav/troubleshooting/#conflicts","title":"Conflicts","text":"<p>When same event is edited on multiple devices:</p> <ol> <li>KashCal uses \"server wins\" by default</li> <li>After 3 failed syncs, local changes are abandoned</li> <li>User is notified via notification</li> </ol>"},{"location":"caldav/troubleshooting/#debug-information","title":"Debug Information","text":"<p>Settings \u2192 Sync History shows: - Last sync timestamp - Events pulled/pushed - Parse errors - Network failures</p>"},{"location":"caldav/troubleshooting/#force-full-sync","title":"Force Full Sync","text":"<p>Clears all sync tokens and re-downloads everything:</p> <ol> <li>Settings \u2192 Force Full Sync</li> <li>Wait for sync to complete</li> <li>Check Sync History for results</li> </ol>"},{"location":"development/build/","title":"Build Guide","text":""},{"location":"development/build/#prerequisites","title":"Prerequisites","text":"<ul> <li>JDK 17+</li> <li>Android SDK (API 35)</li> <li>Android Studio (optional, for IDE features)</li> </ul>"},{"location":"development/build/#quick-build","title":"Quick Build","text":"<pre><code># Debug build\n./gradlew assembleDebug\n\n# Run tests\n./gradlew test\n\n# Specific test\n./gradlew test --tests \"*EventsDao*\"\n\n# Clean build\n./gradlew clean assembleDebug\n</code></pre>"},{"location":"development/build/#project-structure","title":"Project Structure","text":"<pre><code>KashCal/\n\u251c\u2500\u2500 app/\n\u2502   \u251c\u2500\u2500 src/main/kotlin/org/onekash/kashcal/\n\u2502   \u2502   \u251c\u2500\u2500 data/           # Room database, credentials\n\u2502   \u2502   \u251c\u2500\u2500 domain/         # Business logic\n\u2502   \u2502   \u251c\u2500\u2500 sync/           # CalDAV synchronization\n\u2502   \u2502   \u251c\u2500\u2500 ui/             # Compose UI\n\u2502   \u2502   \u251c\u2500\u2500 widget/         # Home screen widgets\n\u2502   \u2502   \u251c\u2500\u2500 reminder/       # Notification scheduling\n\u2502   \u2502   \u2514\u2500\u2500 di/             # Hilt modules\n\u2502   \u251c\u2500\u2500 src/test/           # Unit tests\n\u2502   \u2514\u2500\u2500 src/androidTest/    # Instrumented tests\n\u251c\u2500\u2500 icaldav/                # CalDAV parsing library\n\u251c\u2500\u2500 gradle/                 # Version catalog\n\u2514\u2500\u2500 releases/               # Signed APKs\n</code></pre>"},{"location":"development/build/#version-management","title":"Version Management","text":"<p>Versions are managed in <code>version.properties</code>:</p> <pre><code>VERSION_CODE=244\nVERSION_NAME=21.5.8\n</code></pre>"},{"location":"development/build/#signing-configuration","title":"Signing Configuration","text":""},{"location":"development/build/#local-development","title":"Local Development","text":"<p>Create <code>local.properties</code>:</p> <pre><code>KEYSTORE_FILE=/path/to/keystore.jks\nKEYSTORE_PASSWORD=your_password\nKEY_ALIAS=release\nKEY_PASSWORD=your_key_password\n</code></pre>"},{"location":"development/build/#cigithub-actions","title":"CI/GitHub Actions","text":"<p>Set GitHub Secrets:</p> <ul> <li><code>KEYSTORE_BASE64</code> - Base64-encoded keystore</li> <li><code>KEYSTORE_PASSWORD</code></li> <li><code>KEY_ALIAS</code></li> <li><code>KEY_PASSWORD</code></li> </ul>"},{"location":"development/build/#release-process","title":"Release Process","text":""},{"location":"development/build/#private-testing","title":"Private Testing","text":"<pre><code># 1. Update version.properties\n# 2. Build release APK\n./gradlew clean assembleRelease\n\n# 3. Copy to releases/\ncp app/build/outputs/apk/release/app-release.apk releases/KashCal-X.Y.Z-release.apk\n\n# 4. Verify signature\napksigner verify -v releases/KashCal-X.Y.Z-release.apk\n</code></pre>"},{"location":"development/build/#public-release","title":"Public Release","text":"<p>CRITICAL: Use CI for public releases (F-Droid reproducibility).</p> <pre><code># 1. Cherry-pick to public repo\ncd /path/to/public-KashCal\ngit cherry-pick &lt;commit&gt;\ngit push origin main\n\n# 2. Create tag\ngit tag vX.Y.Z\ngit push origin vX.Y.Z\n\n# 3. Create release WITHOUT APK\ngh release create vX.Y.Z --repo KashCal/KashCal \\\n  --title \"vX.Y.Z\" --notes \"Release notes\"\n\n# 4. CI automatically builds and attaches APK\n</code></pre>"},{"location":"development/build/#key-dependencies","title":"Key Dependencies","text":"Dependency Version Purpose Kotlin 2.1.0 Language Compose BOM 2024.12.01 UI framework Room 2.7.0 Database Hilt 2.53.1 Dependency injection OkHttp 4.12.0 HTTP client WorkManager 2.10.0 Background jobs Glance 1.1.1 Widgets"},{"location":"development/build/#testing","title":"Testing","text":""},{"location":"development/build/#unit-tests-robolectric","title":"Unit Tests (Robolectric)","text":"<pre><code>./gradlew testDebugUnitTest\n</code></pre> <p>Tests run with Robolectric for Android framework mocking.</p>"},{"location":"development/build/#test-coverage","title":"Test Coverage","text":"<pre><code>./gradlew koverHtmlReport\n</code></pre> <p>Report generated at <code>app/build/reports/kover/html/</code>.</p>"},{"location":"development/build/#database-schema","title":"Database Schema","text":"<p>Schema exported to <code>app/schemas/</code> for migration tracking:</p> <pre><code>ls app/schemas/org.onekash.kashcal.data.db.KashCalDatabase/\n# 1.json, 2.json, ..., 12.json\n</code></pre>"},{"location":"development/build/#code-generation","title":"Code Generation","text":"<p>KSP generates Room DAOs and Hilt components:</p> <pre><code>ksp {\n    arg(\"room.schemaLocation\", \"$projectDir/schemas\")\n    arg(\"room.incremental\", \"true\")\n    arg(\"room.generateKotlin\", \"true\")\n}\n</code></pre>"},{"location":"development/build/#proguard","title":"ProGuard","text":"<p>Release builds use ProGuard for optimization:</p> <pre><code>buildTypes {\n    release {\n        isMinifyEnabled = true\n        isShrinkResources = true\n        proguardFiles(\n            getDefaultProguardFile(\"proguard-android-optimize.txt\"),\n            \"proguard-rules.pro\"\n        )\n    }\n}\n</code></pre>"},{"location":"development/build/#troubleshooting","title":"Troubleshooting","text":""},{"location":"development/build/#robolectric-jit-crash","title":"Robolectric JIT Crash","text":"<p>If tests crash with JIT errors:</p> <pre><code>testOptions {\n    unitTests {\n        it.jvmArgs(\"-XX:TieredStopAtLevel=1\")  // Disable C2 JIT\n    }\n}\n</code></pre>"},{"location":"development/build/#ical4j-service-loader-conflicts","title":"ical4j Service Loader Conflicts","text":"<p>Handled via <code>pickFirsts</code>:</p> <pre><code>packagingOptions {\n    pickFirsts += \"META-INF/services/net.fortuna.ical4j.model.ComponentFactory\"\n    pickFirsts += \"META-INF/services/net.fortuna.ical4j.model.PropertyFactory\"\n}\n</code></pre>"},{"location":"development/contributing/","title":"Contributing","text":""},{"location":"development/contributing/#getting-started","title":"Getting Started","text":"<ol> <li>Fork the repository</li> <li>Clone your fork</li> <li>Create a feature branch</li> <li>Make changes</li> <li>Run tests</li> <li>Submit pull request</li> </ol>"},{"location":"development/contributing/#code-style","title":"Code Style","text":"<ul> <li>Kotlin coding conventions</li> <li>No emojis in code (unless user-requested)</li> <li>Prefer editing existing files over creating new ones</li> <li>Use domain layer (EventCoordinator) - never access DAOs from ViewModels</li> </ul>"},{"location":"development/contributing/#pull-request-guidelines","title":"Pull Request Guidelines","text":"<ul> <li>Keep PRs focused on single feature/fix</li> <li>Include tests for new functionality</li> <li>Update documentation if needed</li> <li>Follow existing patterns</li> </ul>"},{"location":"development/contributing/#architecture-rules","title":"Architecture Rules","text":"<ul> <li>ViewModels \u2192 Domain Layer \u2192 Data Layer</li> <li>Never skip layers</li> <li>Use Flow for reactive data</li> <li>Use @Transaction for multi-step operations</li> </ul>"},{"location":"development/contributing/#commit-messages","title":"Commit Messages","text":"<pre><code>feat: Add recurring event editing\nfix: Correct timezone handling for all-day events\ndocs: Update CalDAV sync documentation\ntest: Add PullStrategy unit tests\n</code></pre>"},{"location":"development/testing/","title":"Testing","text":""},{"location":"development/testing/#running-tests","title":"Running Tests","text":"<pre><code># All unit tests\n./gradlew testDebugUnitTest\n\n# Specific test class\n./gradlew testDebugUnitTest --tests \"*EventsDaoTest*\"\n\n# With coverage\n./gradlew koverHtmlReport\n</code></pre>"},{"location":"development/testing/#test-structure","title":"Test Structure","text":"<pre><code>app/src/test/kotlin/org/onekash/kashcal/\n\u251c\u2500\u2500 data/\n\u2502   \u251c\u2500\u2500 db/dao/           # DAO tests (Robolectric)\n\u2502   \u251c\u2500\u2500 credential/       # Credential manager tests\n\u2502   \u2514\u2500\u2500 repository/       # Repository tests\n\u251c\u2500\u2500 domain/               # Business logic tests\n\u251c\u2500\u2500 sync/                 # Sync strategy tests\n\u2514\u2500\u2500 ui/                   # ViewModel tests\n</code></pre>"},{"location":"development/testing/#key-test-libraries","title":"Key Test Libraries","text":"<ul> <li>JUnit 4 - Test framework</li> <li>MockK - Kotlin mocking</li> <li>Turbine - Flow testing</li> <li>Robolectric - Android framework mocking</li> <li>MockWebServer - HTTP mocking</li> </ul>"},{"location":"development/testing/#writing-tests","title":"Writing Tests","text":""},{"location":"development/testing/#dao-tests","title":"DAO Tests","text":"<pre><code>@RunWith(RobolectricTestRunner::class)\nclass EventsDaoTest {\n    private lateinit var database: KashCalDatabase\n    private lateinit var eventsDao: EventsDao\n\n    @Before\n    fun setup() {\n        database = Room.inMemoryDatabaseBuilder(...)\n        eventsDao = database.eventsDao()\n    }\n}\n</code></pre>"},{"location":"development/testing/#flow-tests","title":"Flow Tests","text":"<pre><code>@Test\nfun `events flow emits updates`() = runTest {\n    eventsDao.getAll().test {\n        assertEquals(emptyList(), awaitItem())\n        eventsDao.insert(testEvent)\n        assertEquals(listOf(testEvent), awaitItem())\n    }\n}\n</code></pre>"},{"location":"features/recurring-events/","title":"Recurring Events","text":"<p>KashCal provides full RFC 5545 RRULE support for recurring events with proper exception handling.</p>"},{"location":"features/recurring-events/#creating-recurring-events","title":"Creating Recurring Events","text":""},{"location":"features/recurring-events/#supported-patterns","title":"Supported Patterns","text":"Pattern RRULE Example Daily <code>FREQ=DAILY</code> Every day Every N days <code>FREQ=DAILY;INTERVAL=3</code> Every 3 days Weekly <code>FREQ=WEEKLY</code> Every week Specific days <code>FREQ=WEEKLY;BYDAY=MO,WE,FR</code> Mon, Wed, Fri Biweekly <code>FREQ=WEEKLY;INTERVAL=2</code> Every 2 weeks Monthly (same day) <code>FREQ=MONTHLY;BYMONTHDAY=15</code> 15th of each month Monthly (last day) <code>FREQ=MONTHLY;BYMONTHDAY=-1</code> Last day of month Monthly (Nth weekday) <code>FREQ=MONTHLY;BYDAY=2TU</code> 2nd Tuesday Yearly <code>FREQ=YEARLY</code> Same date each year"},{"location":"features/recurring-events/#end-conditions","title":"End Conditions","text":"Condition RRULE Description Forever (none) No end date Count <code>COUNT=10</code> After 10 occurrences Until date <code>UNTIL=20261231</code> Until Dec 31, 2026"},{"location":"features/recurring-events/#occurrence-materialization","title":"Occurrence Materialization","text":"<p>Recurring events are expanded into the <code>occurrences</code> table for efficient queries.</p>"},{"location":"features/recurring-events/#expansion-window","title":"Expansion Window","text":"<ul> <li>Default: Current date \u00b1 2 years</li> <li>On-demand: Extended when user navigates beyond window</li> </ul> <pre><code>// Expansion triggered by navigation\nfun triggerOccurrenceExtension(targetDateMs: Long) {\n    viewModelScope.launch {\n        delay(500)  // Debounce\n        eventCoordinator.extendOccurrencesIfNeeded(targetDateMs)\n    }\n}\n</code></pre>"},{"location":"features/recurring-events/#rrule-formula-rfc-5545","title":"RRULE Formula (RFC 5545)","text":"<pre><code>RecurrenceSet = (DTSTART \u222a RRULE \u222a RDATE) - EXDATE\n</code></pre> <ul> <li>DTSTART: First occurrence</li> <li>RRULE: Recurrence rule</li> <li>RDATE: Additional specific dates</li> <li>EXDATE: Excluded dates</li> </ul>"},{"location":"features/recurring-events/#editing-recurring-events","title":"Editing Recurring Events","text":""},{"location":"features/recurring-events/#edit-options","title":"Edit Options","text":"<p>When editing a recurring event occurrence, users choose:</p> <ol> <li>This Event Only - Creates an exception</li> <li>This and All Future - Splits the series</li> <li>All Events - Modifies the master</li> </ol>"},{"location":"features/recurring-events/#exception-events-edit-single-occurrence","title":"Exception Events (Edit Single Occurrence)","text":"<pre><code>// User modifies single occurrence\neventCoordinator.editSingleOccurrence(\n    masterEventId = event.originalEventId ?: event.id,\n    occurrenceTimeMs = selectedOccurrenceTs,\n    changes = { it.copy(title = \"Modified Title\") }\n)\n</code></pre> <p>What happens:</p> <ol> <li>Create exception event with same UID as master</li> <li>Set <code>originalEventId</code> pointing to master</li> <li>Set <code>originalInstanceTime</code> (RECURRENCE-ID)</li> <li>Link occurrence to exception via <code>exceptionEventId</code></li> <li>Queue master for UPDATE (exception bundled in .ics)</li> </ol>"},{"location":"features/recurring-events/#split-series-edit-this-and-all-future","title":"Split Series (Edit This and All Future)","text":"<pre><code>eventCoordinator.editThisAndFuture(\n    masterEventId = masterEvent.id,\n    splitTimeMs = selectedOccurrenceTs,\n    changes = { it.copy(title = \"New Title\") }\n)\n</code></pre> <p>What happens:</p> <ol> <li>Add UNTIL to master's RRULE (truncate)</li> <li>Delete occurrences at/after split point</li> <li>Create NEW event with modifications</li> <li>Generate occurrences for new series</li> <li>Queue both events for sync</li> </ol>"},{"location":"features/recurring-events/#deleting-recurring-events","title":"Deleting Recurring Events","text":""},{"location":"features/recurring-events/#delete-options","title":"Delete Options","text":"Option Effect This Event Only Add to EXDATE, cancel occurrence This and All Future Truncate RRULE with UNTIL All Events Delete entire series"},{"location":"features/recurring-events/#delete-single-occurrence","title":"Delete Single Occurrence","text":"<pre><code>eventCoordinator.deleteSingleOccurrence(\n    masterEventId = masterEvent.id,\n    occurrenceTimeMs = selectedOccurrenceTs\n)\n</code></pre> <p>What happens:</p> <ol> <li>Add timestamp to master's <code>exdate</code> field</li> <li>Mark occurrence as <code>isCancelled = true</code></li> <li>Delete exception event if one exists</li> <li>Queue master for UPDATE</li> </ol>"},{"location":"features/recurring-events/#delete-this-and-all-future","title":"Delete This and All Future","text":"<pre><code>eventCoordinator.deleteThisAndFuture(\n    masterEventId = masterEvent.id,\n    fromTimeMs = selectedOccurrenceTs\n)\n</code></pre> <p>What happens:</p> <ol> <li>Add UNTIL to RRULE (before fromTimeMs)</li> <li>Delete occurrences at/after fromTimeMs</li> <li>Delete exception events for deleted occurrences</li> <li>Queue master for UPDATE</li> </ol>"},{"location":"features/recurring-events/#exception-event-model","title":"Exception Event Model","text":"<p>KashCal uses \"Model B\" for exception events:</p> <pre><code>Master Event (id=100, rrule=\"FREQ=WEEKLY\")\n  \u2514\u2500\u2500 Occurrence: eventId=100, exceptionEventId=101\n\nException Event (id=101, originalEventId=100)\n  \u2514\u2500\u2500 (no separate occurrence - linked to master's)\n</code></pre>"},{"location":"features/recurring-events/#key-properties","title":"Key Properties","text":"<ul> <li>Exception shares master's UID (RFC 5545)</li> <li>Distinguished by <code>originalInstanceTime</code> (RECURRENCE-ID)</li> <li><code>syncStatus = SYNCED</code> (bundled with master)</li> <li>No RRULE, EXDATE, RDATE on exceptions</li> </ul>"},{"location":"features/recurring-events/#loading-for-display","title":"Loading for Display","text":"<pre><code>// CRITICAL: Use exceptionEventId if present\nval eventId = occurrence.exceptionEventId ?: occurrence.eventId\nval event = eventReader.getEventById(eventId)\n</code></pre>"},{"location":"features/recurring-events/#rrulebuilder-api","title":"RruleBuilder API","text":"<p>Type-safe RRULE construction for UI:</p> <pre><code>// Build RRULE strings\nval rrule = RruleBuilder.weekly(interval = 1, days = setOf(MONDAY, WEDNESDAY))\n// \u2192 \"FREQ=WEEKLY;BYDAY=MO,WE\"\n\nval rrule = RruleBuilder.monthlyNthWeekday(ordinal = 2, weekday = TUESDAY)\n// \u2192 \"FREQ=MONTHLY;BYDAY=2TU\"\n\nval rrule = RruleBuilder.withCount(baseRrule, count = 10)\n// \u2192 \"FREQ=WEEKLY;COUNT=10\"\n\n// Parse for display\nval display = RruleBuilder.formatForDisplay(rrule)\n// \u2192 \"Weekly on Mon, Wed\"\n\n// Parse for UI state\nval parsed = RruleBuilder.parseRrule(rrule, ...)\n// \u2192 ParsedRecurrence(frequency=WEEKLY, weekdays=[MONDAY, WEDNESDAY])\n</code></pre>"},{"location":"features/recurring-events/#timezone-handling","title":"Timezone Handling","text":""},{"location":"features/recurring-events/#all-day-events","title":"All-Day Events","text":"<p>All-day events are stored as UTC midnight. Occurrences use day codes (YYYYMMDD) for timezone-agnostic display.</p> <pre><code>// Force UTC for all-day expansion\nval tz = if (event.isAllDay) {\n    TimeZone.getTimeZone(\"UTC\")\n} else {\n    TimeZone.getTimeZone(event.timezone ?: TimeZone.getDefault().id)\n}\n</code></pre>"},{"location":"features/recurring-events/#timed-events","title":"Timed Events","text":"<p>Timed events preserve the original timezone in the <code>timezone</code> field and display correctly across DST transitions.</p>"},{"location":"features/reminders/","title":"Reminders","text":"<p>KashCal supports configurable event reminders with notification actions.</p>"},{"location":"features/reminders/#setting-reminders","title":"Setting Reminders","text":"<p>Each event supports up to 3 reminders: - First Alert (default: 15 minutes before) - Second Alert (default: off)</p>"},{"location":"features/reminders/#options-for-timed-events","title":"Options for Timed Events","text":"<ul> <li>At time of event</li> <li>5, 10, 15, 30 minutes before</li> <li>1, 2 hours before</li> <li>1 day, 2 days, 1 week before</li> </ul>"},{"location":"features/reminders/#options-for-all-day-events","title":"Options for All-Day Events","text":"<ul> <li>On day of event (9 AM)</li> <li>1 day, 2 days, 1 week before (9 AM)</li> </ul>"},{"location":"features/reminders/#notification-actions","title":"Notification Actions","text":"<p>When a reminder fires: - Snooze - Reschedule 15 minutes later - Dismiss - Cancel notification</p> <p>Tap notification to open event details.</p>"},{"location":"features/reminders/#technical-details","title":"Technical Details","text":"<ul> <li>Uses <code>AlarmManager</code> for precise timing</li> <li>Reminders survive device reboot</li> <li>All-day reminders fire at 9 AM local time</li> <li>Timezone-aware for travel</li> </ul>"},{"location":"features/reminders/#permissions","title":"Permissions","text":"<p>Android 13+ requires notification permission. KashCal requests this when creating events with reminders.</p>"},{"location":"features/search/","title":"Search","text":"<p>KashCal uses FTS4 full-text search for fast event lookup.</p>"},{"location":"features/search/#using-search","title":"Using Search","text":"<ol> <li>Tap search icon in toolbar</li> <li>Type search query</li> <li>Results appear instantly</li> <li>Tap result to view event</li> </ol>"},{"location":"features/search/#search-features","title":"Search Features","text":""},{"location":"features/search/#text-matching","title":"Text Matching","text":"<ul> <li>Searches title, location, description</li> <li>Prefix matching (\"meet\" finds \"meeting\")</li> <li>Case-insensitive</li> </ul>"},{"location":"features/search/#date-filtering","title":"Date Filtering","text":"<ul> <li>Any time (default)</li> <li>Today, Tomorrow</li> <li>This week, Next week</li> <li>This month, Next month</li> <li>Custom date range</li> </ul>"},{"location":"features/search/#options","title":"Options","text":"<ul> <li>Include past events toggle</li> </ul>"},{"location":"features/search/#technical-details","title":"Technical Details","text":"<ul> <li>FTS4 virtual table (10-100x faster than LIKE)</li> <li>Room auto-syncs via triggers</li> <li>Max 100 results per query</li> <li>Results sorted by next occurrence</li> </ul>"},{"location":"features/widgets/","title":"Home Screen Widgets","text":"<p>KashCal provides three Glance-based widgets for your home screen.</p>"},{"location":"features/widgets/#agenda-widget","title":"Agenda Widget","text":"<p>Shows today's events in a compact list.</p> <ul> <li>Header with current date</li> <li>Up to 5 events with time and title</li> <li>Calendar color indicators</li> <li>\"+N more\" for additional events</li> <li>Tap event to view details</li> <li>Tap header to open app</li> </ul>"},{"location":"features/widgets/#week-widget","title":"Week Widget","text":"<p>7-day rolling calendar with event summaries.</p> <ul> <li>Day headers with date and event count</li> <li>Events grouped by day</li> <li>Multi-day events span appropriately</li> <li>Tap day to navigate</li> <li>Tap empty day to create event</li> </ul>"},{"location":"features/widgets/#date-widget","title":"Date Widget","text":"<p>Simple 1x1 date display.</p> <ul> <li>Current day name (SUN, MON, etc.)</li> <li>Date number</li> <li>Tap to open app</li> </ul>"},{"location":"features/widgets/#widget-updates","title":"Widget Updates","text":"<p>Widgets refresh: - Every 30 minutes (periodic) - At midnight (new day) - After event changes - On timezone change</p>"},{"location":"features/widgets/#adding-widgets","title":"Adding Widgets","text":"<ol> <li>Long-press home screen</li> <li>Select \"Widgets\"</li> <li>Find \"KashCal\"</li> <li>Drag widget to home screen</li> </ol>"},{"location":"getting-started/accounts/","title":"Adding Accounts","text":"<p>KashCal supports multiple CalDAV account types for calendar synchronization.</p>"},{"location":"getting-started/accounts/#icloud","title":"iCloud","text":""},{"location":"getting-started/accounts/#prerequisites","title":"Prerequisites","text":"<p>iCloud requires an app-specific password (not your Apple ID password).</p>"},{"location":"getting-started/accounts/#generate-app-specific-password","title":"Generate App-Specific Password","text":"<ol> <li>Go to appleid.apple.com</li> <li>Sign in with your Apple ID</li> <li>Navigate to App-Specific Passwords</li> <li>Click Generate Password</li> <li>Name it \"KashCal\" and click Create</li> <li>Copy the 16-character password</li> </ol>"},{"location":"getting-started/accounts/#add-to-kashcal","title":"Add to KashCal","text":"<ol> <li>Open KashCal Settings</li> <li>Tap Add iCloud Account</li> <li>Enter your Apple ID email</li> <li>Paste the app-specific password</li> <li>Tap Sign In</li> </ol> <p>KashCal will discover your calendars automatically.</p>"},{"location":"getting-started/accounts/#nextcloud","title":"Nextcloud","text":""},{"location":"getting-started/accounts/#add-account","title":"Add Account","text":"<ol> <li>Open KashCal Settings</li> <li>Tap Add CalDAV Account</li> <li>Enter server URL: <code>https://your-nextcloud.com/remote.php/dav</code></li> <li>Enter username and password</li> <li>Tap Connect</li> </ol>"},{"location":"getting-started/accounts/#server-url-format","title":"Server URL Format","text":"<pre><code>https://your-nextcloud.com/remote.php/dav\n</code></pre>"},{"location":"getting-started/accounts/#self-hosted-caldav","title":"Self-Hosted CalDAV","text":"<p>KashCal works with any RFC 4791 compliant CalDAV server.</p>"},{"location":"getting-started/accounts/#tested-servers","title":"Tested Servers","text":"Server Status Notes Radicale Tested Python-based, lightweight Baikal Tested PHP-based Stalwart Tested Rust-based, all-in-one"},{"location":"getting-started/accounts/#generic-setup","title":"Generic Setup","text":"<ol> <li>Open KashCal Settings</li> <li>Tap Add CalDAV Account</li> <li>Enter your server URL (usually ends with <code>/dav</code> or <code>/caldav</code>)</li> <li>Enter credentials</li> <li>Toggle Trust Self-Signed Certificates if using self-signed SSL</li> <li>Tap Connect</li> </ol>"},{"location":"getting-started/accounts/#troubleshooting","title":"Troubleshooting","text":"<p>Discovery fails:</p> <ul> <li>Check server URL format</li> <li>Verify <code>.well-known/caldav</code> redirect is configured</li> <li>Try direct calendar URL instead of discovery</li> </ul> <p>Authentication errors:</p> <ul> <li>Double-check username/password</li> <li>Some servers require email as username</li> <li>Check server logs for details</li> </ul>"},{"location":"getting-started/accounts/#multiple-accounts","title":"Multiple Accounts","text":"<p>KashCal supports multiple accounts of the same type:</p> <ul> <li>Multiple iCloud accounts (different Apple IDs)</li> <li>Multiple CalDAV servers</li> <li>Mix of iCloud + CalDAV + local</li> </ul> <p>Each account's calendars appear in separate groups in the calendar picker.</p>"},{"location":"getting-started/accounts/#account-management","title":"Account Management","text":""},{"location":"getting-started/accounts/#disable-account","title":"Disable Account","text":"<ol> <li>Settings \u2192 Accounts</li> <li>Tap account name</li> <li>Toggle Enabled off</li> </ol> <p>Disabled accounts don't sync but data is preserved.</p>"},{"location":"getting-started/accounts/#remove-account","title":"Remove Account","text":"<ol> <li>Settings \u2192 Accounts</li> <li>Tap account name</li> <li>Tap Sign Out</li> </ol> <p>Warning: Removing an account deletes all associated calendars and events from the device.</p>"},{"location":"getting-started/accounts/#calendar-visibility","title":"Calendar Visibility","text":"<p>After adding an account:</p> <ol> <li>Settings \u2192 Calendars</li> <li>Toggle checkboxes to show/hide calendars</li> <li>Set default calendar for new events</li> </ol>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#download-options","title":"Download Options","text":""},{"location":"getting-started/installation/#f-droid-recommended","title":"F-Droid (Recommended)","text":"<p>KashCal is available on F-Droid, the open-source Android app store.</p> <ol> <li>Install F-Droid</li> <li>Search for \"KashCal\"</li> <li>Tap Install</li> </ol>"},{"location":"getting-started/installation/#github-releases","title":"GitHub Releases","text":"<p>Download the latest APK from GitHub Releases.</p> <ol> <li>Download the <code>.apk</code> file</li> <li>Enable \"Install from unknown sources\" if prompted</li> <li>Open the APK to install</li> </ol>"},{"location":"getting-started/installation/#build-from-source","title":"Build from Source","text":"<p>See the Build Guide for instructions.</p>"},{"location":"getting-started/installation/#first-launch","title":"First Launch","text":"<p>On first launch, KashCal:</p> <ol> <li>Creates a local calendar (\"On This Device\")</li> <li>Sets up notification channels</li> <li>Schedules background sync worker</li> </ol> <p>You can start creating events immediately - no account required.</p>"},{"location":"getting-started/installation/#permissions","title":"Permissions","text":"<p>KashCal requests the following permissions:</p> Permission Purpose Required Internet CalDAV sync For sync only Notifications Event reminders Optional Contacts Birthday import Optional Exact Alarms Precise reminders Auto-granted for calendar apps"},{"location":"getting-started/installation/#storage","title":"Storage","text":"<p>KashCal stores data in:</p> <ul> <li>Room Database - Events, calendars, sync state</li> <li>EncryptedSharedPreferences - Credentials (AES-256)</li> <li>DataStore - User preferences</li> </ul> <p>All data is excluded from Android backup by default.</p>"},{"location":"getting-started/overview/","title":"Overview","text":"<p>KashCal is a workflow-first calendar app designed for users who want control over their calendar data.</p>"},{"location":"getting-started/overview/#philosophy","title":"Philosophy","text":""},{"location":"getting-started/overview/#offline-first","title":"Offline-First","text":"<p>KashCal works without an internet connection. Events are saved locally first, then synchronized in the background when connectivity is available.</p>"},{"location":"getting-started/overview/#privacy-focused","title":"Privacy-Focused","text":"<ul> <li>No analytics or tracking</li> <li>Credentials encrypted with Android Keystore</li> <li>No cloud services required (self-hosted CalDAV supported)</li> </ul>"},{"location":"getting-started/overview/#standards-based","title":"Standards-Based","text":"<p>Built on open standards:</p> <ul> <li>RFC 4791 - CalDAV protocol</li> <li>RFC 5545 - iCalendar format</li> <li>RFC 6578 - WebDAV Sync</li> </ul>"},{"location":"getting-started/overview/#features","title":"Features","text":""},{"location":"getting-started/overview/#core-calendar","title":"Core Calendar","text":"<ul> <li>Create, edit, delete events</li> <li>Recurring events with full RRULE support</li> <li>Exception handling (edit/delete single occurrences)</li> <li>Multi-day events</li> <li>All-day events with timezone awareness</li> <li>Location with map integration</li> <li>Full-text search (FTS4)</li> </ul>"},{"location":"getting-started/overview/#caldav-sync","title":"CalDAV Sync","text":"<ul> <li>iCloud (with app-specific password)</li> <li>Nextcloud</li> <li>Self-hosted (Radicale, Baikal, Stalwart)</li> <li>FastMail</li> <li>Any RFC 4791 compliant server</li> </ul>"},{"location":"getting-started/overview/#additional-features","title":"Additional Features","text":"<ul> <li>ICS subscriptions (holidays, sports, etc.)</li> <li>Contact birthday import</li> <li>Home screen widgets (Agenda, Week, Date)</li> <li>Configurable reminders with snooze</li> <li>Calendar color customization</li> <li>First day of week preference</li> </ul>"},{"location":"getting-started/overview/#system-requirements","title":"System Requirements","text":"<ul> <li>Android 8.0 (API 26) or higher</li> <li>~50MB storage</li> <li>Internet connection for sync (offline mode available)</li> </ul>"},{"location":"getting-started/overview/#getting-started","title":"Getting Started","text":"<ol> <li>Install - Download from F-Droid or GitHub Releases</li> <li>Create Events - Local calendar is ready immediately</li> <li>Add Account - Connect iCloud, Nextcloud, or CalDAV server</li> <li>Sync - Events sync automatically in background</li> </ol>"},{"location":"reference/database/","title":"Database Schema","text":""},{"location":"reference/database/#entities","title":"Entities","text":"Entity Purpose Account CalDAV account credentials and sync state Calendar Calendar metadata and visibility Event Calendar events (73 columns) Occurrence Materialized RRULE expansions PendingOperation Offline sync queue ScheduledReminder Alarm scheduling SyncLog Sync audit trail IcsSubscription ICS feed subscriptions EventFts FTS4 search index"},{"location":"reference/database/#current-version","title":"Current Version","text":"<p>Database version: 12</p> <p>See Data Layer for migration history.</p>"},{"location":"reference/database/#key-relationships","title":"Key Relationships","text":"<pre><code>Account (1) \u2192 (N) Calendar\nCalendar (1) \u2192 (N) Event\nEvent (1) \u2192 (N) Occurrence\nEvent (master) \u2192 (N) Event (exceptions)\n</code></pre>"},{"location":"reference/database/#important-indices","title":"Important Indices","text":"<ul> <li><code>events(calendar_id, uid, original_instance_time)</code> - Exception lookup</li> <li><code>occurrences(start_day, end_day)</code> - Range queries</li> <li><code>events_fts</code> - Full-text search</li> </ul>"},{"location":"reference/patterns/","title":"Critical Patterns","text":"<p>These patterns prevent bugs. Violating them will break functionality.</p>"},{"location":"reference/patterns/#1-use-domain-layer-not-daos","title":"1. Use Domain Layer, Not DAOs","text":"<p>ViewModels must never access DAOs directly.</p> <pre><code>// CORRECT\nclass CalendarViewModel(\n    private val coordinator: EventCoordinator,  // Writes\n    private val eventReader: EventReader        // Reads\n)\n\n// WRONG\nclass CalendarViewModel(private val eventsDao: EventsDao)\n</code></pre>"},{"location":"reference/patterns/#2-always-use-transaction-for-multi-step-operations","title":"2. Always Use @Transaction for Multi-Step Operations","text":"<pre><code>@Transaction\nsuspend fun createException(master: Event, occurrence: Long): Event {\n    val exception = eventsDao.insert(...)\n    occurrencesDao.linkException(...)\n    return exception\n}\n</code></pre>"},{"location":"reference/patterns/#3-time-based-queries-use-occurrences-table","title":"3. Time-Based Queries: Use Occurrences Table","text":"<p>CRITICAL: Never filter events by <code>Event.endTs</code> for time-based queries. This field is the first occurrence's end time, not the series end.</p> <pre><code>// CORRECT\n@Query(\"\"\"\n    SELECT DISTINCT events.* FROM events\n    JOIN occurrences ON events.id = occurrences.event_id\n    WHERE occurrences.end_ts &gt;= :now\n\"\"\")\nsuspend fun getEventsWithFutureOccurrences(now: Long): List&lt;Event&gt;\n\n// WRONG - breaks for recurring events!\nevents.filter { it.endTs &gt;= now }\n</code></pre>"},{"location":"reference/patterns/#4-self-contained-sync-operations","title":"4. Self-Contained Sync Operations","text":"<p>PendingOperation must store ALL context needed at queue time.</p> <pre><code>// CORRECT: Store URL at queue time\npendingOpsDao.insert(PendingOperation(\n    eventId = eventId,\n    operation = OPERATION_MOVE,\n    targetUrl = oldCaldavUrl,  // Captured BEFORE clearing\n    targetCalendarId = newCalendarId\n))\n\n// WRONG: Read URL at process time - already null!\nval url = event.caldavUrl\n</code></pre>"},{"location":"reference/patterns/#5-exception-events-share-master-uid","title":"5. Exception Events Share Master UID","text":"<p>CRITICAL: Exception events MUST have the same UID as their master event (RFC 5545).</p> <pre><code>// CORRECT\nval exceptionEvent = modifiedEvent.copy(\n    uid = masterEvent.uid,  // Same UID\n    originalEventId = masterEventId,\n    syncStatus = SyncStatus.SYNCED  // Bundled with master\n)\n// Queue UPDATE on MASTER (not CREATE on exception)\nqueueOperation(masterEventId, OPERATION_UPDATE)\n\n// WRONG: Different UID creates separate event\nuid = \"${masterEvent.uid}-${occurrenceTimeMs}\"\n</code></pre>"},{"location":"reference/patterns/#6-use-flow-for-observable-data-sources","title":"6. Use Flow for Observable Data Sources","text":"<p>Use Room's Flow for time-sensitive queries so UI updates progressively during sync.</p> <pre><code>// CORRECT: UI updates as events are written\nfun loadEventsForDay(dayCode: Int) {\n    dayEventsJob?.cancel()\n    dayEventsJob = viewModelScope.launch {\n        eventReader.getVisibleOccurrencesForDay(dayCode)\n            .distinctUntilChanged()\n            .collect { occurrences -&gt;\n                _uiState.value = _uiState.value.copy(dayEvents = occurrences)\n            }\n    }\n}\n\n// WRONG: UI empty until sync completes\nsuspend fun loadEventsForDay(dayCode: Int) {\n    val occurrences = eventReader.getOccurrencesForDayOnce(dayCode)\n    _uiState.value = _uiState.value.copy(dayEvents = occurrences)\n}\n</code></pre>"},{"location":"reference/patterns/#7-use-coercein-for-input-bounds","title":"7. Use coerceIn() for Input Bounds","text":"<p>When using bit-shift operations, always bound both min AND max.</p> <pre><code>// CORRECT\nval multiplier = 1L shl retryCount.coerceIn(0, 10)\n\n// WRONG: Negative values cause undefined behavior\nval multiplier = 1L shl retryCount.coerceAtMost(10)\n</code></pre>"},{"location":"reference/patterns/#8-exception-events-cannot-be-manipulated-directly","title":"8. Exception Events Cannot Be Manipulated Directly","text":"<p>Exception events must go through the master event.</p> <pre><code>// CORRECT\nval masterEventId = event.originalEventId ?: event.id\neventCoordinator.deleteSingleOccurrence(masterEventId, occurrenceTs)\n\n// WRONG: Throws IllegalArgumentException\neventCoordinator.deleteEvent(exceptionEvent.id)\n</code></pre>"},{"location":"reference/patterns/#9-load-exception-events-using-exceptioneventid","title":"9. Load Exception Events Using exceptionEventId","text":"<p>When loading events from occurrences, use <code>exceptionEventId ?: eventId</code>.</p> <pre><code>// CORRECT\nval eventIds = occurrences.map { occ -&gt;\n    occ.exceptionEventId ?: occ.eventId\n}.distinct()\nval events = eventIds.mapNotNull { eventReader.getEventById(it) }\n\n// WRONG: Always loads master instead of exception\nval eventIds = occurrences.map { it.eventId }.distinct()\n</code></pre>"},{"location":"reference/patterns/#10-all-day-event-ispast-use-day-code-comparison","title":"10. All-Day Event isPast: Use Day Code Comparison","text":"<p>For all-day events, use day code comparison instead of timestamp comparison.</p> <pre><code>// CORRECT\nval isPast = DateTimeUtils.isEventPast(\n    occurrence.endTs,\n    occurrence.endDay,\n    event.isAllDay\n)\n\n// WRONG: Fails for all-day events in negative UTC offsets\nval isPast = occurrence.endTs &lt; System.currentTimeMillis()\n</code></pre>"},{"location":"reference/patterns/#11-token-ctag-coordination","title":"11. Token + ctag Coordination","text":"<p>When holding sync-token due to parse failures, ctag must also be held.</p> <pre><code>return PullResult.Success(\n    newSyncToken = effectiveSyncToken,\n    // Coordinate ctag with token decision\n    newCtag = if (effectiveSyncToken == calendar.syncToken)\n        calendar.ctag  // Hold ctag too\n    else\n        null  // Advance ctag\n)\n</code></pre>"},{"location":"reference/patterns/#12-use-explicit-pendingintents","title":"12. Use Explicit PendingIntents","text":"<p>Always use explicit intents when creating PendingIntents (CWE-927).</p> <pre><code>// CORRECT: Explicit intent with target class\nval intent = Intent(context, MainActivity::class.java).apply {\n    flags = Intent.FLAG_ACTIVITY_NEW_TASK\n}\nval pendingIntent = PendingIntent.getActivity(\n    context, requestCode, intent,\n    PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE\n)\n\n// WRONG: Implicit intent\nval intent = Intent(\"com.example.ACTION\")\n</code></pre>"},{"location":"reference/patterns/#13-mask-sensitive-data-in-logs","title":"13. Mask Sensitive Data in Logs","text":"<p>Never log full credentials, tokens, or PII.</p> <pre><code>// CORRECT\nLog.d(TAG, \"Saved account: ${appleId.take(3)}***\")\nLog.d(TAG, \"Sync token: ${syncToken?.take(8)}...\")\n\n// WRONG\nLog.d(TAG, \"Saved account: $appleId\")\n</code></pre>"},{"location":"reference/patterns/#14-reminder-sorting-at-sync-time","title":"14. Reminder Sorting at Sync Time","text":"<p>Reminders are sorted by absolute duration (ascending) before storage.</p> <pre><code>reminders.sortedBy { it.trigger?.abs() }\n// -PT15M, PT30M, -PT1H \u2192 closest first\n</code></pre>"},{"location":"reference/patterns/#15-end-time-start-time-validation","title":"15. End Time &gt;= Start Time Validation","text":"<p>Events must have <code>endTs &gt;= startTs</code>. Validation at two layers:</p> <p>UI Layer: Shows error, disables save button</p> <p>Domain Layer:</p> <pre><code>suspend fun createEvent(event: Event, calendarId: Long? = null): Event {\n    require(event.endTs &gt;= event.startTs) {\n        \"End time must be &gt;= start time\"\n    }\n    // ...\n}\n</code></pre>"},{"location":"reference/patterns/#16-conflict-resolution-abandonment","title":"16. Conflict Resolution Abandonment","text":"<p>After 3 sync cycles with unresolved conflict, abandon local changes.</p> <pre><code>if (op.retryCount &gt;= MAX_CONFLICT_SYNC_CYCLES) {\n    // 1. Reset to SYNCED so pull can fetch server version\n    eventsDao.updateSyncStatus(eventId, SyncStatus.SYNCED)\n\n    // 2. Clear ctag to force re-fetch\n    calendarsDao.updateCtag(event.calendarId, null)\n\n    // 3. Re-read calendar for pull (critical!)\n    val calendarForPull = calendarsDao.getById(calendar.id)\n\n    // 4. Notify user\n    notificationManager.showConflictAbandonedNotification(event)\n}\n</code></pre>"}]}